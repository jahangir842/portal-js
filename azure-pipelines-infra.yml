trigger:
  branches:
    include:
      - main        # or your default branch name
  paths:
    include:
      - bicep/*.bicep
      - bicep/*.bicepparam

name: Infra Pipeline with Bicep Files

parameters:
- name: azureServiceConnection
  type: string
  default: 'sp-portal-js-jagz'

variables:
  resourceGroupName: 'rg-portal-js-jagz'
  location: 'Canada Central'
  templateFile: 'bicep/main.bicep'
  parametersFile: 'bicep/main.bicepparam'

pool:
  name: default   # ðŸ‘ˆ your self-hosted pool

steps:

# 1. Ensure Resource Group
- task: AzurePowerShell@5
  displayName: 'Create Resource Group if not exists'
  inputs:
    azureSubscription: ${{ parameters.azureServiceConnection }}
    ScriptType: InlineScript
    pwsh: true
    Inline: |
      $rgName = "$(resourceGroupName)"
      $loc = "$(location)"

      if (-not (Get-AzResourceGroup -Name $rgName -ErrorAction SilentlyContinue)) {
        Write-Host "Resource group $rgName not found. Creating..."
        New-AzResourceGroup -Name $rgName -Location $loc
      } else {
        Write-Host "Resource group $rgName already exists in $loc."
      }
    azurePowerShellVersion: LatestVersion

# 2. Deploy Bicep Template
- task: AzurePowerShell@5
  displayName: 'Deploy Bicep to Resource Group'
  inputs:
    azureSubscription: ${{ parameters.azureServiceConnection }}
    ScriptType: InlineScript
    pwsh: true
    Inline: |
      $rgName   = "$(resourceGroupName)"
      $template = "$(templateFile)"
      $params   = "$(parametersFile)"

      Write-Host "Deploying Bicep template $template to Resource Group $rgName"

      New-AzResourceGroupDeployment `
        -ResourceGroupName $rgName `
        -TemplateFile $template `
        -TemplateParameterFile $params `
        -Mode Incremental `
        -Verbose
    azurePowerShellVersion: LatestVersion
